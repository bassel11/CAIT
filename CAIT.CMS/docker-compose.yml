version: "3.9"

networks:
  cms-network:
    driver: bridge

services:

  # ==========================================
  # 1. INFRASTRUCTURE (Redis, Rabbit, Portainer)
  # ==========================================
  
  # --- RabbitMQ ---
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: cms-rabbitmq
    hostname: rabbitmq
    restart: unless-stopped
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - cms-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # --- Redis (With Config File) ---
  redis:
    image: redis:7.2-alpine
    container_name: cms-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    # قراءة كلمة المرور من ملف .env واستخدام ملف الكونفيج
    command: redis-server /usr/local/etc/redis/redis.conf --requirepass P@ssw0rd
    volumes:
      - ./redis.conf:/usr/local/etc/redis/redis.conf:ro # قراءة الملف من جهازك
      - redis-data:/data
    networks:
      - cms-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "P@ssw0rd", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # --- Redis Insight (GUI) ---
  redis-insight:
    image: redis/redisinsight:latest
    container_name: cms-redis-insight
    restart: unless-stopped
    ports:
      - "5540:5540"
    environment:
      - RI_ALLOW_ANALYTICS=no
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - redis-insight-data:/data
    networks:
      - cms-network

  # --- Portainer (Docker Management) ---
  portainer:
    image: portainer/portainer-ce:latest
    container_name: cms-portainer
    restart: unless-stopped
    ports:
      - "9000:9000"
      - "9443:9443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    networks:
      - cms-network

  # ==========================================
  # 2. API GATEWAY (YARP)
  # ==========================================
  yarpapigateway:
    container_name: cms-yarp-gateway
    image: ${DOCKER_REGISTRY-}yarpapigateway
    build:
      context: .
      dockerfile: ApiGateways/YarpApiGateway/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      # === Yarp Configuration Overrides ===
      # توجيه YARP للاتصال بأسماء الحاويات بدلاً من localhost
      - ReverseProxy__Clusters__identity-cluster__Destinations__destination1__Address=http://identityapi:8080
      - ReverseProxy__Clusters__committee-cluster__Destinations__destination1__Address=http://committeeapi:8080
      - ReverseProxy__Clusters__meeting-cluster__Destinations__destination1__Address=http://meetingapi:8080
      - ReverseProxy__Clusters__decision-cluster__Destinations__destination1__Address=http://decisionapi:8080
      - ReverseProxy__Clusters__task-cluster__Destinations__destination1__Address=http://taskapi:8080
    ports:
      - "8080:8080"
    networks:
      - cms-network
    depends_on:
      - identityapi
      - committeeapi

  # ==========================================
  # 3. MICROSERVICES
  # ==========================================

  # --- Identity Service ---
  identityapi:
    container_name: cms-identity-api
    image: ${DOCKER_REGISTRY-}identityapi
    build:
      context: .
      dockerfile: Services/Identity/Identity.API/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      # SQL Server المحلي
      - ConnectionStrings__IdentityConnectionString=Server=host.docker.internal,1433;Database=IdentityDb;User Id=cms;Password=cms12345;TrustServerCertificate=True;MultipleActiveResultSets=true
      # Redis باستخدام المتغيرات
      - ConnectionStrings__Redis=redis:6379,password=${REDIS_PASSWORD}
      - RabbitMQ__Host=rabbitmq
      # gRPC Setup
      - ASPNETCORE_URLS=http://+:8080;http://+:8081
      - Kestrel__Endpoints__HttpApi__Url=http://+:8080
      - Kestrel__Endpoints__HttpApi__Protocols=Http1
      - Kestrel__Endpoints__Grpc__Url=http://+:8081
      - Kestrel__Endpoints__Grpc__Protocols=Http2
    ports:
      - "5001:8080"
      - "6001:8081"
    networks:
      - cms-network
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy

  # --- Committee Service ---
  committeeapi:
    container_name: cms-committee-api
    image: ${DOCKER_REGISTRY-}committeeapi
    build:
      context: .
      dockerfile: Services/Committee/CommitteeAPI/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__CommitteeConnectionString=Server=host.docker.internal,1433;Database=CommitteeDb;User Id=cms;Password=cms12345;TrustServerCertificate=True;
      - ConnectionStrings__Redis=redis:6379,password=${REDIS_PASSWORD}
      - RabbitMQ__Host=rabbitmq
      # الاتصال الداخلي عبر أسماء الحاويات
      - Services__IdentityBaseUrl=http://identityapi:8080
      - Services__GrpcUrl=http://identityapi:8081
    ports:
      - "5002:8080"
    networks:
      - cms-network
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy

  # --- Meeting Service ---
  meetingapi:
    container_name: cms-meeting-api
    image: ${DOCKER_REGISTRY-}meetingapi
    build:
      context: .
      dockerfile: Services/Meeting/MeetingAPI/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__MeetingConnectionString=Server=host.docker.internal,1433;Database=MeetingDb;User Id=cms;Password=cms12345;TrustServerCertificate=True;
      - ConnectionStrings__Redis=redis:6379,password=${REDIS_PASSWORD}
      - RabbitMQ__Host=rabbitmq
      - Services__IdentityBaseUrl=http://identityapi:8080
      - Services__CommitteeBaseUrl=http://committeeapi:8080
    ports:
      - "5003:8080"
    networks:
      - cms-network
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy

  # --- Decision Service ---
  decisionapi:
    container_name: cms-decision-api
    image: ${DOCKER_REGISTRY-}decisionapi
    build:
      context: .
      dockerfile: Services/Decision/DecisionAPI/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DecisionConnectionString=Server=host.docker.internal,1433;Database=DecisionDb;User Id=cms;Password=cms12345;TrustServerCertificate=True;
      - ConnectionStrings__Redis=redis:6379,password=${REDIS_PASSWORD}
      - RabbitMQ__Host=rabbitmq
      - Services__IdentityBaseUrl=http://identityapi:8080
      - Services__CommitteeBaseUrl=http://committeeapi:8080
    ports:
      - "5004:8080"
    networks:
      - cms-network
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy

  # --- Task Service ---
  taskapi:
    container_name: cms-task-api
    image: ${DOCKER_REGISTRY-}taskapi
    build:
      context: .
      dockerfile: Services/Task/TaskAPI/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__TaskConnectionString=Server=host.docker.internal,1433;Database=TaskDb;User Id=cms;Password=cms12345;TrustServerCertificate=True;
      - ConnectionStrings__Redis=redis:6379,password=${REDIS_PASSWORD}
      - RabbitMQ__Host=rabbitmq
      - Services__IdentityBaseUrl=http://identityapi:8080
      - Services__CommitteeBaseUrl=http://committeeapi:8080
    ports:
      - "5005:8080"
    networks:
      - cms-network
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy

volumes:
  redis-data:
  redis-insight-data:
  portainer_data: