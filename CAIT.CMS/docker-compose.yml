version: "3.9"

networks:
  cms-network:
    driver: bridge

services:

  # ==========================================
  # 1. INFRASTRUCTURE
  # ==========================================
  
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: cms-rabbitmq
    hostname: rabbitmq
    restart: unless-stopped
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASS}
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - cms-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7.2-alpine
    container_name: cms-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --requirepass P@ssw0rd --bind 0.0.0.0 --appendonly yes --protected-mode yes
    volumes:
      # - ./redis.conf:/usr/local/etc/redis/redis.conf:ro
      - redis-data:/data
    networks:
      - cms-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "P@ssw0rd", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis-insight:
    image: redis/redisinsight:latest
    container_name: cms-redis-insight
    restart: unless-stopped
    ports:
      - "5540:5540"
    environment:
      - RI_ALLOW_ANALYTICS=no
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - redis-insight-data:/data
    networks:
      - cms-network

  portainer:
    image: portainer/portainer-ce:latest
    container_name: cms-portainer
    restart: unless-stopped
    ports:
      - "9000:9000"
      - "9443:9443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    networks:
      - cms-network

  # ==========================================
  # 2. API GATEWAY (YARP)
  # ==========================================
  yarpapigateway:
    container_name: cms-yarp-gateway
    image: ${DOCKER_REGISTRY-}yarpapigateway
    build:
      context: .
      dockerfile: ApiGateways/YarpApiGateway/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT}
      - ReverseProxy__Clusters__identity-cluster__Destinations__destination1__Address=http://identityapi:8080
      - ReverseProxy__Clusters__committee-cluster__Destinations__destination1__Address=http://committeeapi:8080
      - ReverseProxy__Clusters__meeting-cluster__Destinations__destination1__Address=http://meetingapi:8080
      - ReverseProxy__Clusters__decision-cluster__Destinations__destination1__Address=http://decisionapi:8080
      - ReverseProxy__Clusters__task-cluster__Destinations__destination1__Address=http://taskapi:8080
      - ReverseProxy__Clusters__audit-cluster__Destinations__destination1__Address=http://auditapi:8080
      - ReverseProxy__Clusters__monitoring-cluster__Destinations__destination1__Address=http://monitoringapi:8080
      - ReverseProxy__Clusters__notification-cluster__Destinations__destination1__Address=http://notificationapi:8080
    ports:
      - "8080:8080"
    networks:
      - cms-network
    depends_on:
      - identityapi
      - committeeapi

  # ==========================================
  # 3. MICROSERVICES
  # ==========================================

  # --- Identity Service (UPDATED WITH ALL CONFIGS) ---
  identityapi:
    container_name: cms-identity-api
    image: ${DOCKER_REGISTRY-}identityapi
    build:
      context: .
      dockerfile: Services/Identity/Identity.API/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT}
      # DB & Infra
      - ConnectionStrings__IdentityConnectionString=Server=${SQL_SERVER};Database=IdentityDb;User Id=${SQL_USER};Password=${SQL_PASSWORD};TrustServerCertificate=True;MultipleActiveResultSets=true
      - ConnectionStrings__Redis=redis:6379,password=${REDIS_PASSWORD}
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=${RABBITMQ_USER}
      - RabbitMQ__Password=${RABBITMQ_PASS}
      # gRPC/HTTP
      - ASPNETCORE_URLS=http://+:8080;http://+:8081
      - Kestrel__Endpoints__HttpApi__Url=http://+:8080
      - Kestrel__Endpoints__HttpApi__Protocols=Http1
      - Kestrel__Endpoints__Grpc__Url=http://+:8081
      - Kestrel__Endpoints__Grpc__Protocols=Http2
      # ✅ LDAP Config
      - Ldap__Url=${LDAP_URL}
      - Ldap__BindDn=${LDAP_BIND_DN}
      - Ldap__BindPassword=${LDAP_BIND_PASSWORD}
      - Ldap__BaseDn=${LDAP_BASE_DN}
      # ✅ Azure AD Config
      - AzureAd__Instance=${AZURE_ID_INSTANCE}
      - AzureAd__Domain=${AZURE_ID_DOMAIN}
      - AzureAd__TenantId=${AZURE_ID_TENANT}
      - AzureAd__ClientId=${AZURE_ID_CLIENT}
      - AzureAd__Audience=${AZURE_ID_AUDIENCE}
      - AzureAd__CallbackPath=${AZURE_ID_CALLBACK}
      # ✅ SMTP Config
      - Smtp__Host=${SMTP_HOST}
      - Smtp__Port=${SMTP_PORT}
      - Smtp__Username=${SMTP_USER}
      - Smtp__Password=${SMTP_PASS}
      - Smtp__FromEmail=${SMTP_FROM}
      - Smtp__EnableSsl=true
    ports:
      - "5001:8080"
      - "6001:8081"
    networks:
      - cms-network
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy

  # --- Committee Service ---
  committeeapi:
    container_name: cms-committee-api
    image: ${DOCKER_REGISTRY-}committeeapi
    build:
      context: .
      dockerfile: Services/Committee/CommitteeAPI/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT}
      - ConnectionStrings__CommitteeConnectionString=Server=${SQL_SERVER};Database=CommitteeDb;User Id=${SQL_USER};Password=${SQL_PASSWORD};TrustServerCertificate=True;
      - ConnectionStrings__Redis=redis:6379,password=${REDIS_PASSWORD}
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=${RABBITMQ_USER}
      - RabbitMQ__Password=${RABBITMQ_PASS}
      - Services__IdentityBaseUrl=http://identityapi:8080
      - Services__GrpcUrl=http://identityapi:8081
    ports:
      - "5002:8080"
    networks:
      - cms-network
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy

  # --- Meeting Service ---
  meetingapi:
    container_name: cms-meeting-api
    image: ${DOCKER_REGISTRY-}meetingapi
    build:
      context: .
      dockerfile: Services/Meeting/MeetingAPI/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT}
      - ConnectionStrings__MeetingConnectionString=Server=${SQL_SERVER};Database=MeetingDb;User Id=${SQL_USER};Password=${SQL_PASSWORD};TrustServerCertificate=True;
      - ConnectionStrings__Redis=redis:6379,password=${REDIS_PASSWORD}
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=${RABBITMQ_USER}
      - RabbitMQ__Password=${RABBITMQ_PASS}
      - Services__IdentityBaseUrl=http://identityapi:8080
      - Services__CommitteeBaseUrl=http://committeeapi:8080
      - Smtp__Host=${SMTP_HOST}
      - Smtp__Port=${SMTP_PORT}
      - Smtp__Username=${SMTP_USER}
      - Smtp__Password=${SMTP_PASS}
      - Smtp__FromEmail=${SMTP_FROM}
      - Smtp__EnableSsl=true
    ports:
      - "5003:8080"
    networks:
      - cms-network
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy

  # --- Decision Service ---
  decisionapi:
    container_name: cms-decision-api
    image: ${DOCKER_REGISTRY-}decisionapi
    build:
      context: .
      dockerfile: Services/Decision/DecisionAPI/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT}
      - ConnectionStrings__DecisionConnectionString=Server=${SQL_SERVER};Database=DecisionDb;User Id=${SQL_USER};Password=${SQL_PASSWORD};TrustServerCertificate=True;
      - ConnectionStrings__Redis=redis:6379,password=${REDIS_PASSWORD}
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=${RABBITMQ_USER}
      - RabbitMQ__Password=${RABBITMQ_PASS}
      - Services__IdentityBaseUrl=http://identityapi:8080
      - Services__CommitteeBaseUrl=http://committeeapi:8080
      - FeatureManagement__DecisionIntegration=true
    ports:
      - "5004:8080"
    networks:
      - cms-network
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy

  # --- Task Service ---
  taskapi:
    container_name: cms-task-api
    image: ${DOCKER_REGISTRY-}taskapi
    build:
      context: .
      dockerfile: Services/Task/TaskAPI/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT}
      - ConnectionStrings__TaskConnectionString=Server=${SQL_SERVER};Database=TaskDb;User Id=${SQL_USER};Password=${SQL_PASSWORD};TrustServerCertificate=True;
      - ConnectionStrings__Redis=redis:6379,password=${REDIS_PASSWORD}
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=${RABBITMQ_USER}
      - RabbitMQ__Password=${RABBITMQ_PASS}
      - Services__IdentityBaseUrl=http://identityapi:8080
      - Services__CommitteeBaseUrl=http://committeeapi:8080
      - QuartzSettings__EnableEscalationJob=false
      - QuartzSettings__EnableReminderJob=true
    ports:
      - "5005:8080"
    networks:
      - cms-network
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy

  # --- Audit Service ---
  auditapi:
    container_name: cms-audit-api
    image: ${DOCKER_REGISTRY-}auditapi
    build:
      context: .
      dockerfile: Services/Audit/Audit.API/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT}
      - ConnectionStrings__AuditConnectionString=Server=${SQL_SERVER};Database=AuditDb;User Id=${SQL_USER};Password=${SQL_PASSWORD};TrustServerCertificate=True;
      - ConnectionStrings__Redis=redis:6379,password=${REDIS_PASSWORD}
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=${RABBITMQ_USER}
      - RabbitMQ__Password=${RABBITMQ_PASS}
      - Services__IdentityBaseUrl=http://identityapi:8080
    ports:
      - "5006:8080"
    networks:
      - cms-network
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy

  # --- Integration Service ---
  integrationservice:
    container_name: cms-integration-service
    image: ${DOCKER_REGISTRY-}integrationservice
    build:
      context: .
      dockerfile: Services/Integration/IntegrationService/Dockerfile
    environment:
      - ConnectionStrings__IntegrationConnectionString=Server=${SQL_SERVER};Database=IntegrationDb;User Id=${SQL_USER};Password=${SQL_PASSWORD};TrustServerCertificate=True;
      - ConnectionStrings__Redis=redis:6379,password=${REDIS_PASSWORD}
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=${RABBITMQ_USER}
      - RabbitMQ__Password=${RABBITMQ_PASS}
      # Azure AD Config
      - AzureAd__TenantId=${AZURE_INT_TENANT}
      - AzureAd__ClientId=${AZURE_INT_CLIENT}
      - AzureAd__ClientSecret=${AZURE_INT_SECRET}
      - AzureAd__OrganizerUserId=${AZURE_INT_ORGANIZER}
    ports:
      - "5007:8080"
    networks:
      - cms-network
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy

  # --- Monitoring Service ---
  monitoringapi:
    container_name: cms-monitoring-api
    image: ${DOCKER_REGISTRY-}monitoringapi
    build:
      context: .
      dockerfile: Services/Monitoring/Monitoring.API/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT}
      - ConnectionStrings__MonitoringConnectionString=Server=${SQL_SERVER};Database=MonitoringDb;User Id=${SQL_USER};Password=${SQL_PASSWORD};TrustServerCertificate=True;
      - ConnectionStrings__Redis=redis:6379,password=${REDIS_PASSWORD}
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=${RABBITMQ_USER}
      - RabbitMQ__Password=${RABBITMQ_PASS}
      - Services__IdentityBaseUrl=http://identityapi:8080
      - Services__CommitteeBaseUrl=http://committeeapi:8080
    ports:
      - "5008:8080"
    networks:
      - cms-network
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy

  # --- Notification Service ---
  notificationapi:
    container_name: cms-notification-api
    image: ${DOCKER_REGISTRY-}notificationapi
    build:
      context: .
      dockerfile: Services/Notification/NotificationService/Dockerfile
    environment:
      - ConnectionStrings__NotificationConnectionString=Server=${SQL_SERVER};Database=NotificationDb;User Id=${SQL_USER};Password=${SQL_PASSWORD};TrustServerCertificate=True;
      - ConnectionStrings__Redis=redis:6379,password=${REDIS_PASSWORD}
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=${RABBITMQ_USER}
      - RabbitMQ__Password=${RABBITMQ_PASS}
      - Services__IdentityBaseUrl=http://identityapi:8080
      - Services__CommitteeBaseUrl=http://committeeapi:8080
      # SMTP Config
      - Smtp__Host=${SMTP_HOST}
      - Smtp__Port=${SMTP_PORT}
      - Smtp__Username=${SMTP_USER}
      - Smtp__Password=${SMTP_PASS}
      - Smtp__FromEmail=${SMTP_FROM}
      - Smtp__EnableSsl=true
    ports:
      - "5009:8080"
    networks:
      - cms-network
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy

volumes:
  redis-data:
  redis-insight-data:
  portainer_data: